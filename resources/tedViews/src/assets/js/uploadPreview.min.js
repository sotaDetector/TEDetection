/*
 *插件作者:周祥
 *插件介绍:图片上传本地预览插件
 *插件网站:http://jquery.decadework.com
 *作  者QQ:200592114
 */
// 引入提示样式
import { Message} from 'view-design';

var uploadPreview = function(setting) {
	var _self = this;
	_self.IsNull = function(value) {
		if (typeof (value) == "function") {
			return false;
		}
		if (value == undefined || value == null || value == ""
				|| value.length == 0) {
			return true
		}
		;
		return false;
	};
	_self.DefautlSetting = {
		UpBtn : "",
		DivShow : "",
		ImgShow : "",
		ImgShowByName : "",
		Width : 100,
		Height : 100,
		ImgType : [ "jpeg", "jpg", "bmp", "png" ],
		ErrMsg : "选择文件错误,图片类型必须是(jpeg,jpg,bmp,png)中的一种",
		ErrMsgForOutSize : "选择文件过大",
		defaultImg : "",
		callback : function() {
		}
	};
	_self.Setting = {
		UpBtn : _self.IsNull(setting.UpBtn) ? _self.DefautlSetting.UpBtn
				: setting.UpBtn,
		DivShow : _self.IsNull(setting.DivShow) ? _self.DefautlSetting.DivShow
				: setting.DivShow,
		ImgShow : _self.IsNull(setting.ImgShow) ? _self.DefautlSetting.ImgShow
				: setting.ImgShow,
		ImgShowByName : _self.IsNull(setting.ImgShowByName) ? _self.DefautlSetting.ImgShowByName
				: setting.ImgShowByName,
		Width : _self.IsNull(setting.Width) ? _self.DefautlSetting.Width
				: setting.Width,
		Height : _self.IsNull(setting.Height) ? _self.DefautlSetting.Height
				: setting.Height,
		ImgType : _self.IsNull(setting.ImgType) ? _self.DefautlSetting.ImgType
				: setting.ImgType,
		ErrMsg : _self.IsNull(setting.ErrMsg) ? _self.DefautlSetting.ErrMsg
				: setting.ErrMsg,
		callback : _self.IsNull(setting.callback) ? _self.DefautlSetting.callback
				: setting.callback,
		ImgSize : setting.ImgSize,
		ErrMsgForOutSize : _self.IsNull(setting.ErrMsgForOutSize) ? _self.DefautlSetting.ErrMsgForOutSize
				: setting.ErrMsgForOutSize,
		defaultImg : _self.IsNull(setting.defaultImg) ? _self.DefautlSetting.defaultImg
				: setting.defaultImg
	};
	_self.getObjectURL = function(file) {
		var url = null;
		if (window.createObjectURL != undefined) {
			url = window.createObjectURL(file);
		} else if (window.URL != undefined) {
			url = window.URL.createObjectURL(file);
		} else if (window.webkitURL != undefined) {
			url = window.webkitURL.createObjectURL(file);
		}
		;
		return url;
	};
	_self.Bind = function() {
		document.getElementById(_self.Setting.UpBtn).onchange = function() {
			if (this.value) {
				if (!RegExp("\.(" + _self.Setting.ImgType.join("|") + ")$", "i")
						.test(this.value.toLowerCase())) {
					//alert(_self.Setting.ErrMsg);
					// showError(_self.Setting.ErrMsg, 3500);
					Message.error(_self.Setting.ErrMsg)
					if(_self.Setting.defaultImg){
						if(_self.Setting.ImgShow){
							document.getElementById(_self.Setting.ImgShow).src = _self.Setting.defaultImg;
						}
						if(document.getElementsByName(_self.Setting.ImgShowByName) && document.getElementsByName(_self.Setting.ImgShowByName).length > 0){
							for(var i=0; i<document.getElementsByName(_self.Setting.ImgShowByName).length; i++){
								document.getElementsByName(_self.Setting.ImgShowByName)[i].src = _self.Setting.defaultImg;
							}
						}
					}
					this.value = "";
					return false
				};
				try {
					if(getPhotoSize(this)>_self.Setting.ImgSize){
						// showError(_self.Setting.ErrMsgForOutSize, 3500);
						Message.error(_self.Setting.ErrMsgForOutSize)
						if(_self.Setting.defaultImg){
							if(_self.Setting.ImgShow){
								document.getElementById(_self.Setting.ImgShow).src = _self.Setting.defaultImg;
							}
							if(document.getElementsByName(_self.Setting.ImgShowByName) && document.getElementsByName(_self.Setting.ImgShowByName).length > 0){
								for(var i=0; i<document.getElementsByName(_self.Setting.ImgShowByName).length; i++){
									document.getElementsByName(_self.Setting.ImgShowByName)[i].src = _self.Setting.defaultImg;
								}
							}
						}
						this.value = "";
						return false
					}
				} catch (e) {
					
				}
				if (navigator.userAgent.indexOf("MSIE") > -1) {
					try {
						if(_self.Setting.ImgShow){
							document.getElementById(_self.Setting.ImgShow).src = _self
							.getObjectURL(this.files[0]);
						}
						if(document.getElementsByName(_self.Setting.ImgShowByName) && document.getElementsByName(_self.Setting.ImgShowByName).length > 0){
							for(var i=0; i<document.getElementsByName(_self.Setting.ImgShowByName).length; i++){
								document.getElementsByName(_self.Setting.ImgShowByName)[i].src = _self.getObjectURL(this.files[0]);
							}
						}
					} catch (e) {
						var div = document
								.getElementById(_self.Setting.DivShow);
						this.select();
						top.parent.document.body.focus();
						var src = document.selection.createRange().text;
						document.selection.empty();
						if(_self.Setting.ImgShow){
							document.getElementById(_self.Setting.ImgShow).style.display = "none";
						}
						if(document.getElementsByName(_self.Setting.ImgShowByName) && document.getElementsByName(_self.Setting.ImgShowByName).length > 0){
							for(var i=0; i<document.getElementsByName(_self.Setting.ImgShowByName).length; i++){
								document.getElementsByName(_self.Setting.ImgShowByName)[i].src = _self.Setting.defaultImg;
							}
						}
						div.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale)";
						div.style.width = _self.Setting.Width + "px";
						div.style.height = _self.Setting.Height + "px";
						div.filters
								.item("DXImageTransform.Microsoft.AlphaImageLoader").src = src;
					}
				} else {
					if(_self.Setting.ImgShow){
						document.getElementById(_self.Setting.ImgShow).src = _self
						.getObjectURL(this.files[0]);
					}
					if(document.getElementsByName(_self.Setting.ImgShowByName) && document.getElementsByName(_self.Setting.ImgShowByName).length > 0){
						for(var i=0; i<document.getElementsByName(_self.Setting.ImgShowByName).length; i++){
							document.getElementsByName(_self.Setting.ImgShowByName)[i].src = _self.getObjectURL(this.files[0]);
						}
					}
				};
				_self.Setting.callback();
			}else{
				if(_self.Setting.defaultImg){
					if(_self.Setting.ImgShow){
						document.getElementById(_self.Setting.ImgShow).src = _self.Setting.defaultImg;
					}
					if(document.getElementsByName(_self.Setting.ImgShowByName) && document.getElementsByName(_self.Setting.ImgShowByName).length > 0){
						for(var i=0; i<document.getElementsByName(_self.Setting.ImgShowByName).length; i++){
							document.getElementsByName(_self.Setting.ImgShowByName)[i].src = _self.Setting.defaultImg;
						}
					}
				}
			}
		}
	};
	_self.Bind();
}

//判断照片大小
function getPhotoSize(obj){
//  photoExt=obj.value.substr(obj.value.lastIndexOf(".")).toLowerCase();//获得文件后缀名
//  if(photoExt!='.jpg'){
//    alert("请上传后缀名为jpg的照片!");
//    return false;
//  }
  var fileSize = 0;
  var isIE = /msie/i.test(navigator.userAgent) && !window.opera;      
  if (isIE && !obj.files) {     
     var filePath = obj.value;      
     var fileSystem = new ActiveXObject("Scripting.FileSystemObject");  
     var file = fileSystem.GetFile (filePath);        
     fileSize = file.Size;     
  }else { 
     fileSize = obj.files[0].size;   
  } 
//  fileSize=Math.round(fileSize/1024*100)/100; //单位为KB
//  if(fileSize>=10){
//    alert("照片最大尺寸为10KB，请重新上传!");
//    return false;
//  }
	return fileSize;
}
export {
	uploadPreview
}